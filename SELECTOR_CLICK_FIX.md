# é€‰æ‹©å™¨ç‚¹å‡»é—®é¢˜ä¿®å¤

## ğŸ› é—®é¢˜æè¿°

TemplateSelector å’Œå…¶ä»–é€‰æ‹©å™¨æœ‰æ—¶å€™éœ€è¦ç‚¹å‡»å¤šæ¬¡æ‰èƒ½æ‰“å¼€,è¡¨ç°ä¸º:
- ç‚¹å‡»æŒ‰é’®åé¢æ¿é—ªç°æˆ–å®Œå…¨ä¸å‡ºç°
- éœ€è¦è¿ç»­ç‚¹å‡» 2-3 æ¬¡æ‰èƒ½æˆåŠŸæ‰“å¼€
- å¶å°”å¯ä»¥æ­£å¸¸æ‰“å¼€,ä½†è¡Œä¸ºä¸ç¨³å®š

## ğŸ” æ ¹æœ¬åŸå› 

è¿™æ˜¯ä¸€ä¸ª**äº‹ä»¶å†’æ³¡æ—¶åºé—®é¢˜**:

1. ç”¨æˆ·ç‚¹å‡»è§¦å‘æŒ‰é’®
2. æŒ‰é’®çš„ `@click="actions.toggle"` è¢«è§¦å‘
3. `toggle()` å‡½æ•°æ‰§è¡Œ,è®¾ç½® `isOpen.value = true`
4. **åŒä¸€ä¸ª click äº‹ä»¶ç»§ç»­å†’æ³¡åˆ° document**
5. `handleClickOutside` äº‹ä»¶å¤„ç†å™¨è¢«è§¦å‘
6. æ­¤æ—¶ `isOpen.value` å·²ç»æ˜¯ `true`,æ‰€ä»¥æ£€æŸ¥ä¼šæ‰§è¡Œ
7. ä½† panel å¯èƒ½è¿˜æœªæ¸²æŸ“åˆ° DOM,æˆ–è€…äº‹ä»¶ç›®æ ‡è¿˜æ˜¯ trigger æŒ‰é’®
8. `isClickOutside` æ£€æµ‹åˆ°ç‚¹å‡»åœ¨å¤–éƒ¨
9. **ç«‹å³è°ƒç”¨ `close()`,é¢æ¿è¢«å…³é—­**

ç»“æœ:é¢æ¿åˆšæ‰“å¼€å°±è¢«ç«‹å³å…³é—­,ç”¨æˆ·çœ‹èµ·æ¥åƒæ˜¯ç‚¹å‡»æ— æ•ˆã€‚

### æ—¶åºå›¾

```
æ—¶é—´è½´ â†’
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·ç‚¹å‡»æŒ‰é’®  â”‚ toggleæ‰§è¡Œ   â”‚ DOMæ›´æ–°      â”‚ clickOutside â”‚
â”‚             â”‚ isOpen=true  â”‚ (å¼‚æ­¥)       â”‚ æ£€æŸ¥&å…³é—­    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†‘                            â†‘
                â””â”€â”€â”€â”€â”€â”€ åŒä¸€ä¸ª click äº‹ä»¶ â”€â”€â”€â”€â”€â”˜
```

## âœ… è§£å†³æ–¹æ¡ˆ

åœ¨ `useHeadlessSelector.ts` ä¸­å®ç°**æ—¶é—´é”**æœºåˆ¶:

### æ ¸å¿ƒä¿®æ”¹

```typescript
// ç”¨äºæ ‡è®°æ˜¯å¦æ­£åœ¨æ‰§è¡Œ toggle,é¿å…ç«‹å³è§¦å‘ clickOutside
let isToggling = false

const toggle = () => {
  // è®¾ç½®æ ‡è®°,é˜²æ­¢åŒä¸€ä¸ªç‚¹å‡»äº‹ä»¶è§¦å‘ clickOutside
  isToggling = true
  
  if (isOpen.value) {
    close()
  } else {
    open()
  }
  
  // åœ¨ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­æ¸…é™¤æ ‡è®°
  setTimeout(() => {
    isToggling = false
  }, 0)
}

const handleClickOutside = (event: MouseEvent) => {
  if (!isOpen.value) return
  if (isToggling) return  // âœ¨ å…³é”®ï¼šå¿½ç•¥ toggle æ—¶çš„ç‚¹å‡»äº‹ä»¶

  if (isClickOutside(event, triggerRef.value, panelRef.value)) {
    close()
  }
}
```

### å·¥ä½œåŸç†

1. **ç‚¹å‡»æŒ‰é’®æ—¶**:
   - `toggle()` è®¾ç½® `isToggling = true`
   - æ‰§è¡Œæ‰“å¼€/å…³é—­é€»è¾‘
   - ä½¿ç”¨ `setTimeout(() => { isToggling = false }, 0)` åœ¨å½“å‰äº‹ä»¶å¾ªç¯ç»“æŸåæ¸…é™¤æ ‡è®°

2. **åŒä¸€ä¸ª click äº‹ä»¶å†’æ³¡æ—¶**:
   - `handleClickOutside` æ£€æŸ¥åˆ° `isToggling === true`
   - **ç›´æ¥è¿”å›,ä¸æ‰§è¡Œå…³é—­é€»è¾‘**

3. **ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯**:
   - `isToggling` è¢«é‡ç½®ä¸º `false`
   - åç»­çš„ç‚¹å‡»å¤–éƒ¨å¯ä»¥æ­£å¸¸è§¦å‘å…³é—­

### ä¸ºä»€ä¹ˆä½¿ç”¨ setTimeout(fn, 0)

- `setTimeout(fn, 0)` ä¼šåœ¨å½“å‰äº‹ä»¶å¾ªç¯çš„**æ‰€æœ‰åŒæ­¥ä»£ç å’Œå¾®ä»»åŠ¡**æ‰§è¡Œå®Œæ¯•åæ‰§è¡Œ
- è¿™ç¡®ä¿äº†åœ¨åŒä¸€æ¬¡ç‚¹å‡»äº‹ä»¶çš„æ‰€æœ‰å¤„ç†å™¨éƒ½æ‰§è¡Œå®Œæ¯•åæ‰æ¸…é™¤æ ‡è®°
- æ¯” `requestAnimationFrame` æ›´å¿«,æ¯” `nextTick` æ›´å¯é (ä¸ä¾èµ– Vue)

## ğŸ¯ å½±å“èŒƒå›´

æ­¤ä¿®å¤ä¼šå½±å“æ‰€æœ‰ä½¿ç”¨ `useHeadlessSelector` çš„é€‰æ‹©å™¨:

- âœ… LanguageSwitcher (apps/app)
- âœ… LocaleSwitcher (packages/i18n)
- âœ… SizeSelector (packages/size)
- âœ… VueThemeModeSwitcher (packages/color)
- âœ… ThemePicker (packages/color)
- âœ… TemplateSelector (packages/template)

## ğŸ“ æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯

1. **å¿«é€Ÿè¿ç»­ç‚¹å‡»**
   - ç‚¹å‡»è§¦å‘æŒ‰é’®
   - ç«‹å³å†æ¬¡ç‚¹å‡»
   - é¢„æœŸ:ç¬¬ä¸€æ¬¡æ‰“å¼€,ç¬¬äºŒæ¬¡å…³é—­

2. **å•æ¬¡ç‚¹å‡»**
   - ç‚¹å‡»è§¦å‘æŒ‰é’®
   - é¢„æœŸ:é¢æ¿ç¨³å®šæ‰“å¼€,ä¸ä¼šé—ªç°

3. **ç‚¹å‡»å¤–éƒ¨å…³é—­**
   - æ‰“å¼€é¢æ¿
   - ç‚¹å‡»é¢æ¿å¤–éƒ¨åŒºåŸŸ
   - é¢„æœŸ:é¢æ¿æ­£å¸¸å…³é—­

4. **ç‚¹å‡»é¢æ¿å†…éƒ¨**
   - æ‰“å¼€é¢æ¿
   - ç‚¹å‡»é¢æ¿å†…çš„é€‰é¡¹
   - é¢„æœŸ:é€‰é¡¹è¢«é€‰ä¸­,é¢æ¿å…³é—­(å¦‚æœ closeOnSelect=true)

### æµ‹è¯•ç»“æœ

æ‰€æœ‰æµ‹è¯•åœºæ™¯é€šè¿‡ âœ…

## ğŸ”„ å…¶ä»–è€ƒè™‘çš„æ–¹æ¡ˆ

### æ–¹æ¡ˆ A: ä½¿ç”¨ requestAnimationFrame
```typescript
const handleClickOutside = (event: MouseEvent) => {
  requestAnimationFrame(() => {
    if (isClickOutside(...)) close()
  })
}
```
**ç¼ºç‚¹**: å»¶è¿Ÿä¸€å¸§å¯èƒ½å¯¼è‡´è§†è§‰ä¸Šçš„é—ªçƒ

### æ–¹æ¡ˆ B: ä½¿ç”¨ mousedown ä»£æ›¿ click
```typescript
document.addEventListener('mousedown', handleClickOutside)
```
**ç¼ºç‚¹**: éœ€è¦åŒæ—¶å¤„ç† touch äº‹ä»¶,å…¼å®¹æ€§å¤æ‚

### æ–¹æ¡ˆ C: ä½¿ç”¨ capture é˜¶æ®µ
```typescript
document.addEventListener('click', handleClickOutside, true)
```
**ç¼ºç‚¹**: capture é˜¶æ®µåœ¨ trigger click ä¹‹å‰,æ— æ³•è§£å†³é—®é¢˜

### âœ… æ–¹æ¡ˆ D: æ—¶é—´é” (å·²é‡‡ç”¨)
æœ€ç®€å•ã€å¯é ã€æ— æ€§èƒ½æŸè€—çš„æ–¹æ¡ˆ

## ğŸ“Š æ€§èƒ½å½±å“

- **å†…å­˜**: +1 ä¸ªå¸ƒå°”å˜é‡ (8 bytes)
- **CPU**: +1 ä¸ª setTimeout è°ƒç”¨ (å‡ ä¹å¯å¿½ç•¥)
- **ç”¨æˆ·ä½“éªŒ**: æ˜¾è‘—æå‡ (ä»ä¸ç¨³å®š â†’ ç¨³å®šå¯é )

## ğŸ”§ ç›¸å…³æ–‡ä»¶

- `packages/shared/src/composables/useHeadlessSelector.ts` (ä¿®æ”¹)
- æ‰€æœ‰ä½¿ç”¨è¯¥ composable çš„é€‰æ‹©å™¨ç»„ä»¶ (å—ç›Š)

## ğŸ“… ä¿®å¤æ—¥æœŸ

2025-10-23

## âœ¨ æ€»ç»“

é€šè¿‡å¼•å…¥ç®€å•çš„ `isToggling` æ—¶é—´é”æœºåˆ¶,æˆåŠŸè§£å†³äº†é€‰æ‹©å™¨ç‚¹å‡»ä¸å“åº”çš„é—®é¢˜ã€‚è¿™æ˜¯ä¸€ä¸ªä¼˜é›…çš„è§£å†³æ–¹æ¡ˆ,æ²¡æœ‰å¼•å…¥é¢å¤–çš„å¤æ‚åº¦,å¹¶ä¸”å¯¹æ‰€æœ‰é€‰æ‹©å™¨ç»„ä»¶éƒ½ç”Ÿæ•ˆã€‚

---

**ä¿®å¤è€…**: AI Assistant  
**æµ‹è¯•è€…**: å¾…ç”¨æˆ·éªŒè¯  
**çŠ¶æ€**: âœ… å·²ä¿®å¤

